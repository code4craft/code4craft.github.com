<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[非典型代码强迫症]]></title>
  <link href="http://code4craft.github.com/atom.xml" rel="self"/>
  <link href="http://code4craft.github.com/"/>
  <updated>2014-07-01T08:19:26+08:00</updated>
  <id>http://code4craft.github.com/</id>
  <author>
    <name><![CDATA[code4craft]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[缓存不是万灵药]]></title>
    <link href="http://code4craft.github.com/blog/2014/07/01/huan-cun-de-she-ji-ji-qi-ta/"/>
    <updated>2014-07-01T08:00:00+08:00</updated>
    <id>http://code4craft.github.com/blog/2014/07/01/huan-cun-de-she-ji-ji-qi-ta</id>
    <content type="html"><![CDATA[<p>公司有个很重要的服务，因为数据需求非常杂，所以关联的数据表非常多。而这个服务就承担起提供如此多数据的使命。</p>

<!--more-->


<p>现在的做法是极度依赖缓存的，所以数据都读取出来，打包存到缓存中。一旦失效，一条数据大概会需要上百毫秒去读取，于是我们不得不提供一个预热缓存的程序，定期的去扫描。之前出过一次问题就是缓存失效之后，该服务出现大量超时，乃至线程池跑满，整个服务都不可用。</p>

<p>在我的理解中，缓存是一个提高性能的方案，但是绝对不是万灵药，哪痛贴哪。比如这个服务，有些数据可能只有极少需求方需要，但是之前是统统都读取出来，而我觉得正确的做法可能是理清数据需求，从更细粒度去提供。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[分层开发论]]></title>
    <link href="http://code4craft.github.com/blog/2014/06/28/kiss/"/>
    <updated>2014-06-28T22:51:00+08:00</updated>
    <id>http://code4craft.github.com/blog/2014/06/28/kiss</id>
    <content type="html"><![CDATA[<p>做Java开发的都喜欢分层的思想，似乎层次是越多越好。虽然之间我并不喜欢层次太多，但是也没有太多的理由让我去厌恶它。但是最近在做一些开发，刚好用了两种极端的方式来完成。</p>

<!--more-->


<p>最近在跟同事一起开发项目。两个类似的项目，大致都是一个中间层，从数据库载入一些数据，然后调用另外一个服务。从复杂程度上来说，差距并不大。前一个项目因为之前是他在做这块业务，所以由他主导，结果一开始就分成多层结构，从DAL,DOMAIN,BIZ一层一层往上写起，中间大概有5个对象来完成层级的隔离，转来转去。结果结对编程一个星期，终于弄出雏形。</p>

<p>后来我写另外一个项目，因为开发时间紧，所以理清了业务流程之后，划分为三个阶段，直接分为三个模块，模块内部不分层，从外到内开始写，结果半天就完成了。</p>

<p>到底是分层还是不分层好？分层的意思是隔离变化，核心业务与外部调用分开，降低系统与外部的耦合。但是一般来说，互联网应用内部逻辑相对简单，大部分时间都是在干一些数据相互转换的事情，这种事情你要说跟外部不耦合基本不可能。一般来说，考虑到成本问题，除非需求和数据发生变化，否则外部API变动的可能性极小。这样子耦合的成本并没有那么大。</p>

<p>相反，我觉得系统内部的简单性更加重要。越少开发效率越高，修改越容易，也越不容易出错，分层结构必定是增加了复杂度，但是收获却相对较少。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[没有银弹-谈谈软件设计的几个矛盾(二)]]></title>
    <link href="http://code4craft.github.com/blog/2014/06/17/conflict-cont/"/>
    <updated>2014-06-17T07:49:00+08:00</updated>
    <id>http://code4craft.github.com/blog/2014/06/17/conflict-cont</id>
    <content type="html"><![CDATA[<h3>1. 关联与冗余</h3>

<p>数据库第三范式种约定，数据没有传递依赖性，但是在互联网应用中，会存在非常多冗余的情况。冗余的目的主要有几个：</p>

<ol>
<li><p>性能</p>

<p> 将所有需要的数据冗余到一起可以提高性能。</p></li>
<li><p>解耦</p>

<p> 一般来说，互联网行业一般都希望一个应用的逻辑尽可能简单，依赖方尽可能的少。冗余数据可以将多个数据源的数据整合到一个数据源，那么应用本身就无需关心这部分逻辑了。</p></li>
<li><p>允许变更</p>

<p> 如果系统A使用了B的数据之后，又有自己独立变更的需要，那么冗余就必不可少了。</p></li>
</ol>


<p>其实从某种意义上，我觉得2比1更重要。而3则是根据需要来决定。从优先级来说是3&gt;2&gt;1。</p>

<p>冗余的坏处有几个：</p>

<ol>
<li><p>有同步的成本</p>

<p> 如果冗余的是一个会发生更新的数据，那么数据同步的成本就不得不考虑了。</p></li>
<li><p>增加整体复杂度</p>

<p> 其实这个是基于1的基础上的。如果只是冗余了数据，后续无需同步，其实系统会相对简单。但是如果有同步的需求，那么可能会有很多个同步的逻辑甚至系统，最后会让整个系统变得复杂和不可控。</p></li>
</ol>


<p>其实第1条的同步机制总归是可以实现的，但是第2条的复杂度才是最需要考虑的地方。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[没有银弹-谈谈软件设计的几个矛盾]]></title>
    <link href="http://code4craft.github.com/blog/2014/06/16/ruan-jian-she-ji-de-ji-ge-mao-dun/"/>
    <updated>2014-06-16T09:30:00+08:00</updated>
    <id>http://code4craft.github.com/blog/2014/06/16/ruan-jian-she-ji-de-ji-ge-mao-dun</id>
    <content type="html"><![CDATA[<p>最近在做项目的重构和功能改进，设计做了很多，也发生了一些争执。其实总结下来，很多争执的内容其实早就是经典的问题。这些问题没有孰优孰劣，具体采用哪种方案，还得因地制宜，详细分析项目需求和复杂度之后，再做决定。之前很多人都试图只从宏观指导思想来决定设计，最后大家谁也不服谁，所以先把问题确定下来，至少以后思考问题会直接一点。</p>

<!--more-->


<h3>1. 拆分与合并</h3>

<p>从现实世界来说，事物本身就是互相联系的，从这个观点来看，任何对事物的拆分都是不完全正确的。</p>

<p>但是软件开发中，人的理解能力是有限的，而拆分目前看来是降低单个项目复杂度最有效的办法。</p>

<p>拆分有很多级别，最小的可能是拆分代码段，用多个函数代替单个函数，然后是用多个类代替单个类，在Java里面，还可以拆分package，然后拆分jar包，最后拆分成不同的项目。</p>

<p>之前有过很多的争执，关于一个项目要拆还是不拆，以及如何拆。关于这个，我的建议是：</p>

<ol>
<li><p>拆与不拆没有对错</p>

<p> Windows是微内核架构，Linux是单内核架构。微内核意味着内核很小，你可以通过很多个模块去补充它，内核与模块是解耦的。Linux是单内核，就表示所有内核功能会在编译时就确定。可能大家都觉得微内核更好，很多时候它确实更好，但是Linus有个经典的论断：“你不需要管理各个模块，但是你需要处理模块之间的依赖，这个可能比模块本身更复杂”。因为事物本身就是互相联系的，你觉得他们不存在耦合，只是当前使用场景用不到而已。</p></li>
<li><p>系统内部实现对外部透明，保留拆或者不拆的选择权。</p>

<p> 项目自身的复杂度，完全可以靠内部实现解决，对外保持约定好的API，这样对于以后内部的重构，会简单得多。相反，如果暴露了内部实现，那么修改就很困难了。</p></li>
<li><p>对于项目拆分，如果没有充足的理由支持拆分，就不要拆。</p>

<p> 不成熟的拆分，最常见的结果是，随着需求的变化，你不得不打破这种解耦关系，这样反而会带来更多的问题。建议是需求稳定之后，再考虑拆分。</p></li>
<li><p>在系统内部多多进行代码级别的拆分，管理复杂度。</p>

<p> 相比项目的拆分，函数和类级别的拆分成本非常低，值得多用。</p></li>
</ol>


<h3>2. 配置化与灵活性</h3>

<p>一段代码，如果使用一遍，那么我们就直接通过代码实现了。如果我们有几十上百个类似的任务，那么我们就不希望写重复的代码了，我们希望能够通过配置几个不同的参数，从而实现不同的任务。如果任何以后还有不断变化的需求，我们甚至不希望自己写配置，而是有一个运营后台来让需求方(可能是不懂开发的人)直接完成配置。</p>

<p>配置化的开发方式往往对开发者来说有很大的诱惑，从而忽略其中的成本，这个配置最近还有个很火的名字，叫做DSL。但其实配置化和灵活性是矛盾的，配置的表述能力自然要弱于通用语言。当然，也有人尝试使用配置解决所有问题，结果只不过是发明了一门很难用的语言而已。</p>

<p>我自己的框架WebMagic是一个经典的配置与灵活性权衡的例子。WebMagic是一个垂直爬虫框架，爬虫最复杂的是规则的编写，你可以认为这是一个可配置的东西。公司基于它做了一个配置后台，即使是这样，仍然有一些情况，不得不手写Java代码来实现一些功能。</p>

<p>对于这个问题，我的建议是：</p>

<ol>
<li><p>先写代码解决问题，但是提前约定接口。</p>

<p> 第一个阶段，没有谁能预测以后的需求，所以先用你熟悉的代码实现。可以根据你的输入和输出，约定程序级别的接口，相比配置化，这一般来说会容易，如果接口设计得当，也会有具有很大灵活性，以后基本无需更改。</p></li>
<li><p>在有一定积累之后，基于以往的任务做配置化。</p>

<p> 配置的内容是什么呢？首先公共逻辑肯定会在整体框架中，配置的内容应该是不同任务彼此独特的部分。这个配置格式，或者DSL的语法的约定，首先应该基于已有的任务，然后可能考虑一下未来的情况。我是个实践主义者，所以我更多的会参考已有的情况，如果发现这个配置化的框架，对之前的任务都不能满足，那么就需要思考一下它的可行性和必要性了。</p></li>
<li><p>在任何时候都保留能使用代码实现的能力。</p>

<p> 我是个实用主义者。有了配置，如果不提供代码实现的能力，而又有一些复杂的需求，那么就只能扩展配置的能力了。这样只可能会导致这个配置解决框架变得极其庞大和复杂，而相对收益却很低。这个时候，可以通过配置解决大部分问题，然后通过代码解决少量问题，也是不错的选择。</p></li>
</ol>


<h3>3. 总结</h3>

<p>其实还有很多东西没说到，以后补充吧。</p>

<p>总结一句话：软件设计要适应满足需求，同时不断演化。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[关于业务架构的一些思考]]></title>
    <link href="http://code4craft.github.com/blog/2014/06/12/guan-yu-ye-wu-jia-gou-de-yi-xie-si-kao/"/>
    <updated>2014-06-12T07:24:00+08:00</updated>
    <id>http://code4craft.github.com/blog/2014/06/12/guan-yu-ye-wu-jia-gou-de-yi-xie-si-kao</id>
    <content type="html"><![CDATA[<p>最近换了部门，接手了好几个新项目，也进行了一些重构的尝试，总结一些经验。主要针对Web开发领域，算是抛砖引玉了。</p>

<!--more-->


<h2>1. 经历的几种业务架构的方式</h2>

<p>公司是典型的SOA架构，Web层之下就是远程Service。Web层负责调用Service，Service则在内部整合缓存、数据库等内容，实现业务逻辑。</p>

<p>这样的结构没有什么问题，问题就在于Service内部的实现上。即使是Service的一个方法，内部实现也可能很复杂，这就涉及到代码分解的问题。</p>

<p>例如：在一个SNS系统中，我有一个UserService，负责User的CRUD。当然实际逻辑会比较复杂，例如新建User要创建用户，还要初始化积分、等级、收件箱等内容。那么，我该怎么做这件事呢？</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserService</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">addUser</span><span class="o">(</span><span class="n">UserDTO</span> <span class="n">userDTO</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">updateUser</span><span class="o">(</span><span class="n">UserDTO</span> <span class="n">userDTO</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="n">UserDTO</span> <span class="nf">getUser</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">deleteUser</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>1.1 随意拆分式</h3>

<p>我们之前的结构很随意，大部分代码都直接写在Service的实现类中，Service直接访问Dao实现逻辑。如果过于复杂，则会拆分成一些小的内部Service，并把它们聚合起来。这种方式在业务不复杂的时候，其实工作的还挺好的。</p>

<p><img src="http://static.oschina.net/uploads/space/2014/0612/000228_XQfi_190591.png" alt="架构1" /></p>

<h3>1.2 水平分层式</h3>

<p>新接手的项目，老实说业务会更复杂。之前的做法是将业务分为了dal-数据库访问、domain-领域模型抽象、biz-业务逻辑、service-服务集成四层。例如一个查询数据的操作，可能要经历这么多个分层的流转，才能最终提供外部服务。这样分下来，代码的全复杂度确实也低了不少。</p>

<p>但是这个划分让我接手项目的时候困惑了很久，导致我觉得自己是不是理解能力下降了。后来在着手重构的时候，发现其实很多层次边界根本就很模糊了，甚至连参与维护者也不是很清楚。</p>

<p>过多的分层，会增加坏代码的破坏力，如果边界不是足够清晰，那就不如不分。</p>

<p>我理想的水平分层其实Web-Service-Dao已经足够了，因为他们的边界相对清晰，直接把Dao当做模型也工作得挺好，抽象出Domain来，根据已有的经验略微多余。</p>

<p><img src="http://static.oschina.net/uploads/space/2014/0612/000255_uD3s_190591.png" alt="架构2" /></p>

<h3>1.3 垂直拆分式</h3>

<p>今天在做另一个项目的时候，尝试用一个责任链的方式来做这个事情。采用了垂直拆分的方式，将完成一件事，按照不同的模型，进行了细分，分成多个Processor，接口类似下面这样。Service内部只对这些子Processor做链式调用，它甚至也不知道有多少个Processor。结果这种方法出奇的好，大家发现并行开发很方便，测试也好写了，修改也方便了。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Processor</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onAdd</span><span class="o">(</span><span class="n">UserDTO</span> <span class="n">userDTO</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onUpdate</span><span class="o">(</span><span class="n">UserDTO</span> <span class="n">userDTO</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onDelete</span><span class="o">(</span><span class="n">UserDTO</span> <span class="n">userDTO</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="http://static.oschina.net/uploads/space/2014/0612/000311_enMh_190591.png" alt="架构3" /></p>

<h2>2. 结论：几个架构的检验标准</h2>

<p>经过多次的折腾，也接手过不少的项目，我得出这么几个结论：</p>

<h3>2.1 一段逻辑，要能让别人轻松的定位到代码在哪里</h3>

<p>这是我参与了很多项目的感受。好的结构并不需要跟踪很多代码层次，才能发现其中的逻辑到底在哪里。相反坏的架构可能有很多层抽象，单个复杂度不高，但是一段逻辑你根本不知道在哪一层。当然也可能是逻辑本身就揉成一坨，也不容易找到想要的东西。</p>

<p>快速的发现相关逻辑，可以减少很多维护成本。</p>

<p>当然，有些架构有学习成本，但是掌握之后，能够满足这个要求，我觉得也可以算是好的架构。</p>

<h3>2.2 Web开发，可扩展性大于可复用性</h3>

<p>根据我一些有限的经验看来，在互联网领域，复用的需求，其实并不如产品需求变更来的迫切。水平分层很大的动机是复用，但是往往内部的复用程度比较有限。而面对需求的变化，水平分层基本上从上到下都进行修改。而合理的垂直拆分可以只修改一个地方，这也是所谓的开闭原则了。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[重玩了一会wow]]></title>
    <link href="http://code4craft.github.com/blog/2014/06/02/zhong-wan-liao-yi-hui-wow/"/>
    <updated>2014-06-02T06:16:00+08:00</updated>
    <id>http://code4craft.github.com/blog/2014/06/02/zhong-wan-liao-yi-hui-wow</id>
    <content type="html"><![CDATA[<p>最近重新玩了一段WOW，边玩边回忆起大学那段疯狂的时光。WOW好像从另一条支线，串起了我对大学时光的记忆。</p>

<!--more-->


<p>最开始的那个矮人圣骑士出现在丹莫罗的白雪中，是06年4月的事了。上游戏去输入/played，总共时间接近300天。这几天脑子里开始回忆和同学一起下副本，再后来开始raid，经历了工会的起起落落。虽然最怀念的还是才开始探索游戏的乐趣，但是已经不知不觉陷入了装备的游戏中去了。</p>

<p>最近上线跟随机团打通了熊猫人的最后副本——脑残吼，打完腰酸背痛，果然是老了…</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[HttpClient使用坑一则——关于Post Data的encoding]]></title>
    <link href="http://code4craft.github.com/blog/2014/05/26/httpclientshi-yong-keng-yi-ze-guan-yu-postdatade-encoding/"/>
    <updated>2014-05-26T21:31:00+08:00</updated>
    <id>http://code4craft.github.com/blog/2014/05/26/httpclientshi-yong-keng-yi-ze-guan-yu-postdatade-encoding</id>
    <content type="html"><![CDATA[<p>之前有个Http服务，使用Serlvet API实现的，现在遇到一个问题：一个同学使用HttpClient进行POST调用，结果中文传过来都是乱码。</p>

<!--more-->


<p>使用自制抓包工具<a href="https://github.com/code4craft/dp-idea">DP-IDEA</a>抓包分析Http请求，发现类似<code>&amp;value=%3f%3f</code>内容，并且Http头中Content-Type为<code>application/x-www-form-urlencoded</code>。上网查了才发现，Http Post请求也会默认做UrlEncoding，而HttpClient如果不设置，默认会用&#8221;ISO-8859-1&#8221;进行编码，于是改为UTF-8，问题解决！</p>

<p>PS: ISO-8859-1编码时，会将高位字符编码成63(16进制就是3F)，所以以后遇到这个可疑的字符，更加有迹可循一点。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[又一次线上OOM排查经过]]></title>
    <link href="http://code4craft.github.com/blog/2014/05/15/oom-cont/"/>
    <updated>2014-05-15T22:00:00+08:00</updated>
    <id>http://code4craft.github.com/blog/2014/05/15/oom-cont</id>
    <content type="html"><![CDATA[<p>最近线上一个服务又出现了频繁Full GC的情况，导致提供的业务经常超时。问题出现非常不稳定，经过两周的时候，终于又捕捉到了一次Full GC，于是联系运维做Heap Dump之后，经过一系列分析，终于解决问题。这次的问题稍微复杂一点，但是也比较有代表性，用到了VisualVM和MAT两个工具，继续记录如下。</p>

<!--more-->


<h2>现象</h2>

<p>这次使用公司的<a href="https://github.com/dianping/cat">CAT</a>监控平台看到的内存表现如下：</p>

<p><img src="http://static.oschina.net/uploads/space/2014/0516/062243_4GUj_190591.png" alt="http://static.oschina.net/uploads/space/2014/0516/062243_4GUj_190591.png" /></p>

<p>可以看到，具体表现是：</p>

<ol>
<li>在很长一段时间内(数个小时)，New GC比较频繁，Full GC较少(一小时个位数)。</li>
<li>过了某一时间点后，Full GC增加，New GC则减少。</li>
<li>将服务切换下线后，Memory Free逐渐回升，Full GC减少。</li>
</ol>


<p>然后观察某一时刻的JMAP histo的内容如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> num     #instances         #bytes  class name
</span><span class='line'>----------------------------------------------
</span><span class='line'>   1:       5958517     5840833584  [C
</span><span class='line'>   2:         37983      706246056  [B
</span><span class='line'>   3:       5960539      190737248  java.lang.String
</span><span class='line'>   4:       1522282      126603936  [Ljava.lang.Object;
</span><span class='line'>   5:       3692000       88608000  java.lang.Double</span></code></pre></td></tr></table></div></figure>


<p>可以看到&#8221;[C&#8221;即&#8221;char[]&ldquo;占用内存达到了5.8G，它正是String的内部结构，换句话说，因为存在了大量的大String导致这个问题。</p>

<p>联系运维进行了Heap Dump之后，就开始了分析的过程。因为服务器内存有8G，所以相应的DUMP也有8G，对分析也造成了一点小困难。</p>

<p>下面是一些工具的使用过程，操作系统是OS X 10.8。</p>

<h2>使用VisualVM分析</h2>

<p>首先使用VisualVM对Heap Dump进行分析。分析需要比较大的内存，而VisualVM默认的内存是256M，所以需要先设置<code>/Applications/VisualVM.app/Contents/Resources/visualvm/etc/visualvm.conf</code>中的最大内存量，这里我们设置成了4G<code>-J-Xmx4096m</code>。</p>

<p>好了，现在打开dump文件，整个分析过程共占用内存2G，仍然在可接受范围。之后分析内存，可以看到跟之前histo一样的类关系。</p>

<p><img src="http://static.oschina.net/uploads/space/2014/0516/074246_GKl4_190591.png" alt="visual vm class" /></p>

<p>不同的是，这时候可以点进去，查看具体的对象。这里看到，竟然有几个大的String占用了756M的内存，看来我们找到问题了。</p>

<p><img src="http://static.oschina.net/uploads/space/2014/0516/074742_7S5S_190591.png" alt="visual vm object " /></p>

<p>发现一个奇怪的现象：“计算保留大小”之后，这些String的保留大小都是0。</p>

<p>保留大小是什么呢？</p>

<p>它是分析工具从GC roots开始查找，找到的所有不会回收的对象，然后按照引用关系，计算出这个“对象以及它引用的对象”的内存大小。这里很有趣的是，这些对象的保留大小都是0。</p>

<p>开始我甚至以为是工具出了问题，后来想想，其实答案很简单：这些大String是临时对象，没有什么对象持有它——通过分析这些String的依赖关系也说明了这一点。这些对象是可以被回收的，换句话说，并不是有明显的内存泄露。</p>

<p>这个“没有对象持有的String”很有意思，让我想到了，会不会是log的过程中，产生了这个String？因为log的时候，会调用对象的toString()方法，而一个大对象的toString()可能是很大的。查看了一下String的内容，是<code>[Class[field1=xxx,field2=yyy]]</code>这种结构，几乎可以肯定是toString()的结果，那么我们现在只要查看一下具体的内容，到底是哪里太大就可以了。</p>

<p>可惜的是，VisualVM里我尝试了各种方法，都没有办法Dump出这个对象的数据，甚至还尝试了VisualVM提供的OQL。</p>

<p><a href="http://visualvm.java.net/oqlhelp.html">OQL</a>是一种类SQL的表达式，同时整合了一些Javascript的函数功能，但是它的缺点就是太慢了…最后尝试用OQL Dump对象未果。</p>

<p><img src="http://static.oschina.net/uploads/space/2014/0516/075904_N7Sp_190591.png" alt="visual vm oql" /></p>

<h2>使用MAT分析</h2>

<p>转而尝试一下MAT。Eclipse MAT(Memory Analyzer Tool)是一个强大的内存分析工具，它可以方便的分析内存泄露的问题。实际使用之后，确实也感觉到比VisualVM更加强大一些。</p>

<p>我们使用MAT打开Dump文件，这也是一个漫长的过程。与VisualVM不同的是，MAT分析的时候，会在本地产生几个临时文件保存分析结果，所以相应的内存占用会小一些(1G左右)，第二次打开也会快很多。</p>

<p>打开完成后，我们看到可以看到几个占用内存较大的对象，这就是最可疑的内存泄漏源。意外的是Size显示的只有1.3GB，而且我们的大String都没在里面。</p>

<p><img src="http://static.oschina.net/uploads/space/2014/0516/071417_UaCv_190591.png" alt="mat" /></p>

<p>开始我们一度认为是Dump文件有错，后来上网搜索才知道，因为MAT的主要目标是排查内存占用量，所以默认大小是不计算不可达对象的——而我们的String都是不可达对象。对应Eclipse的文档里有介绍<a href="http://wiki.eclipse.org/MemoryAnalyzer/FAQ#How_to_analyse_unreachable_objects">http://wiki.eclipse.org/MemoryAnalyzer/FAQ#How_to_analyse_unreachable_objects</a>。</p>

<p>于是我们按照说明，在&#8221;Preferences=>Memory Analyzer&#8221;中勾选&#8221;Keep Unreachable Objects&#8221;，删除索引文件Dump同路径下的所有&#8221;.index&#8221;，即可看到所有的对象。</p>

<p><img src="http://static.oschina.net/uploads/space/2014/0516/081748_lx9g_190591.png" alt="mat-with-unreachable" /></p>

<p>点击Histogram，即可看到类的占用。在类上选择&#8221;List Objects&#8221;，即可看到所有对象。在对象上选择&#8221;Copy=>Value to File&#8221;，即可保存到文件。</p>

<p><img src="http://static.oschina.net/uploads/space/2014/0516/082102_7Tks_190591.png" alt="mat-objects" /></p>

<h2>原理</h2>

<p>之后我们通过分析对象，发现是因为某个用于缓存的对象使用了一个List结构，但是添加元素的没有去重，导致List越来越大造成的。这个对象本身占用内存只有110M，但是toString()出来的字符串达到700M的大小，所以引起了频繁的GC——最开始对象小的时候是New GC，后来对象大了，直接进入了年老代，就变成了Full GC。</p>

<h2>总结</h2>

<p>回到之前的问题，通过这次分析，我们可以这么总结：</p>

<ol>
<li><p>将服务切换下线后，Memory Free逐渐回升，Full GC减少，Heap Dump的可达对象较少</p>

<p> 这种情况不是内存泄露，有可能是对象创建开销太大造成的。</p></li>
<li><p>在1的前提下，New GC很频繁</p>

<p> 这种情况可能是频繁创建小对象，或者创建一些较大的对象(尚不足以直接进入年老代)</p></li>
<li><p>在1的前提下，Full GC很频繁</p>

<p> 这种情况是频繁创建大对象，或者创建了一些超大对象导致的。</p></li>
<li><p>第3种情况下，大对象toString()产生的大String很可能是罪魁祸首</p></li>
</ol>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[减肥中]]></title>
    <link href="http://code4craft.github.com/blog/2014/05/12/ondiet/"/>
    <updated>2014-05-12T23:04:00+08:00</updated>
    <id>http://code4craft.github.com/blog/2014/05/12/ondiet</id>
    <content type="html"><![CDATA[<p>Github马拉松进行了78天了，希望也以同样的毅力坚持减肥。</p>

<!--more-->


<p>今天看了一篇文章：<a href="http://www.panghufei.com/?p=11163">http://www.panghufei.com/?p=11163</a>，以及BBC的纪录片<a href="http://v.youku.com/v_show/id_XNTYyODM5MjE2.html">视频: BBC 关于减肥你应该知道的十件事</a>。</p>

<p>纪录片很好，总结出来几点：</p>

<ol>
<li>用更小的盘子吃；</li>
<li>用高蛋白的食物、用粥类防止饥饿；</li>
<li>小习惯也能改变体重。</li>
</ol>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[平静]]></title>
    <link href="http://code4craft.github.com/blog/2014/04/27/ping-jing/"/>
    <updated>2014-04-27T21:36:00+08:00</updated>
    <id>http://code4craft.github.com/blog/2014/04/27/ping-jing</id>
    <content type="html"><![CDATA[<p>最近工作有些变动，有点忙。加上WebMagic也发展了一些用户，做了不少支持的工作，也发布了一些版本。终于前几天累倒了，感冒头痛，只能休息。</p>

<p>晚上买了个优酷的一年会员，又看了遍《勇敢的心》。之前因为太长没有看完，这次看的时候，听着平静的苏格兰风笛，有种恍若隔世的感觉。之前做事情太急躁，走得慢一点，才能看更多的风景。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[软件开发是否存在Law?]]></title>
    <link href="http://code4craft.github.com/blog/2014/04/15/ruan-jian-kai-fa-shi-fou-cun-zai-law/"/>
    <updated>2014-04-15T06:57:00+08:00</updated>
    <id>http://code4craft.github.com/blog/2014/04/15/ruan-jian-kai-fa-shi-fou-cun-zai-law</id>
    <content type="html"><![CDATA[<p>昨天跟架构师讨论一个项目的设计，谈到MVC模式。MVC模式，是先从View设计还是先从Model设计？</p>

<!--more-->


<p>架构师的观点是，只要使用了某个模式，其中就存在必然的&#8221;Law&#8221;，不遵循就会误入歧途。例如MVC必须要从Model写起，因为Model是稳定的，是“对自然界的建模”，与业务无关，而View是易变的，是具体业务的展现。</p>

<p>我是实用主义者，我认为一个稳定的Model是需要领域积累的，一开始就做到一个稳定的Model，应对不断变化的需求非常难。很多时候从View写起，可以迅速实现业务。当业务发展到一定阶段，再抽象出一个Model也是水到渠成的事情。开发的过程本身也是对领域加深认识的一个过程。</p>

<p>但是也有些现状是“你不去想就不会有”，一堆View拼凑起来的项目太多了，其实最开始用一个不稳定的Model，加以迭代，最终变成稳定的，也是一个很好的过程？</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[淡然]]></title>
    <link href="http://code4craft.github.com/blog/2014/03/30/dan-ran/"/>
    <updated>2014-03-30T22:36:00+08:00</updated>
    <id>http://code4craft.github.com/blog/2014/03/30/dan-ran</id>
    <content type="html"><![CDATA[<p>马上就是29岁生日了，家里的小家伙也开始会逗我玩了，会求抱抱了。以前陪小家伙感觉更多的是责任，现在越来越觉得她是个小人了。</p>

<p>因为毕业晚，一直都是以新人自居，做事也带着学生那会的习气，有些事情没有承担起相应的责任，比如带宝宝。这一点老婆承担了很多，我虽然也会去配合，但是终归没有那么情愿。</p>

<p>晚上把头像改成了和女儿的合照，以后以老爸自居了。虽然工作经验也有些不足，但是决定不再装嫩了，多一点责任心，年龄的事就随他去吧。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[使用SpringProfile和Mybatis进行多个数据源（H2和Mysql）的切换]]></title>
    <link href="http://code4craft.github.com/blog/2014/03/20/shi-yong-springprofilehe-mybatisjin-xing-duo-ge-shu-ju-yuan-%28h2he-mysql%29de-qie-huan/"/>
    <updated>2014-03-20T09:45:00+08:00</updated>
    <id>http://code4craft.github.com/blog/2014/03/20/shi-yong-springprofilehe-mybatisjin-xing-duo-ge-shu-ju-yuan-(h2he-mysql)de-qie-huan</id>
    <content type="html"><![CDATA[<p>最近在做WebMagic的后台，遇到一个问题：后台用到了数据库，本来理想情况下是用Mysql，但是为了做到开箱即用，也整合了一个嵌入式数据库H2。这里面就有个问题了，如何用一套代码，提供对Mysql和H2两种方案的支持？博主收集了一些资料，也调试了很久，终于找到一套可行方案，记录下来。代码贴的有点多，主要是为了以后方便自己查找。</p>

<!--more-->


<h2>H2的使用</h2>

<p>H2是一个嵌入式，纯Java实现的数据库，它各方面都要好于Java的sqlitejdbc。它可以使用内存模式，也可以使用磁盘模式。具体使用可以看攻略：</p>

<p><a href="http://www.cnblogs.com/gao241/p/3480472.html">http://www.cnblogs.com/gao241/p/3480472.html</a></p>

<h2>为MyBatis同时配置两套数据源</h2>

<p>我们希望达到的效果是，不同的数据源使用不同的sql，并且这个切换最好只在配置中体现，与代码无关。所以我们选择xml的方式编写sql语句。</p>

<h3>MyBatis Spring的使用</h3>

<p>同时使用Mybatis-Spring插件，这样Mybatis可以将Mapper（也就是DAO）自动配置成Bean，非常方便。它的一个完整示例可以看这个项目：<a href="https://github.com/mybatis/jpetstore-6">https://github.com/mybatis/jpetstore-6</a>。这里我配置如下：</p>

<h4>配置Bean</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'> <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;org.mybatis.spring.mapper.MapperScannerConfigurer&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;basePackage&quot;</span> <span class="na">value=</span><span class="s">&quot;us.codecraft.webmagic.dao&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/bean&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;sqlSessionFactory&quot;</span> <span class="na">class=</span><span class="s">&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;dataSource&quot;</span> <span class="na">ref=</span><span class="s">&quot;dataSource&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;mapperLocations&quot;</span> <span class="na">value=</span><span class="s">&quot;classpath*:/config/mapper/**/*.xml&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/bean&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h4>配置Mapper</h4>

<p>对应的DAO和配置文件如下：</p>

<ul>
<li>us.codecraft.webmagic.dao.DynamicClassDao:</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">DynamicClassDao</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">add</span><span class="o">(</span><span class="n">DynamicClass</span> <span class="n">dynamicClass</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>DynamicClassDao.xml</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&quot;us.codecraft.webmagic.dao.DynamicClassDao&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nt">&lt;insert</span> <span class="na">id=</span><span class="s">&quot;add&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;us.codecraft.webmagic.model.DynamicClass&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      insert into DynamicClass (`ClassName`,`SourceCode`,`AddTime`,`UpdateTime`)
</span><span class='line'>      values (#{className},#{sourceCode},now(),now())
</span><span class='line'>    <span class="nt">&lt;/insert&gt;</span>
</span><span class='line'><span class="nt">&lt;/mapper&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>使用databaseIdProvider进行多个数据源的SQL切换</h3>

<p>MyBatis支持根据不同的数据库名来进行SQL语句的切换。做法是初始化<code>SqlSessionFactoryBean</code>的时候，配置一个<code>databaseIdProvider</code>。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;vendorProperties&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.beans.factory.config.PropertiesFactoryBean&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;properties&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;props&gt;</span>
</span><span class='line'>            <span class="nt">&lt;prop</span> <span class="na">key=</span><span class="s">&quot;SQL Server&quot;</span><span class="nt">&gt;</span>sqlserver<span class="nt">&lt;/prop&gt;</span>
</span><span class='line'>            <span class="nt">&lt;prop</span> <span class="na">key=</span><span class="s">&quot;DB2&quot;</span><span class="nt">&gt;</span>db2<span class="nt">&lt;/prop&gt;</span>
</span><span class='line'>            <span class="nt">&lt;prop</span> <span class="na">key=</span><span class="s">&quot;Oracle&quot;</span><span class="nt">&gt;</span>oracle<span class="nt">&lt;/prop&gt;</span>
</span><span class='line'>            <span class="nt">&lt;prop</span> <span class="na">key=</span><span class="s">&quot;MySQL&quot;</span><span class="nt">&gt;</span>mysql<span class="nt">&lt;/prop&gt;</span>
</span><span class='line'>            <span class="nt">&lt;prop</span> <span class="na">key=</span><span class="s">&quot;H2&quot;</span><span class="nt">&gt;</span>h2<span class="nt">&lt;/prop&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/props&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/property&gt;</span>
</span><span class='line'><span class="nt">&lt;/bean&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;databaseIdProvider&quot;</span> <span class="na">class=</span><span class="s">&quot;org.apache.ibatis.mapping.VendorDatabaseIdProvider&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;properties&quot;</span> <span class="na">ref=</span><span class="s">&quot;vendorProperties&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;/bean&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;sqlSessionFactory&quot;</span> <span class="na">class=</span><span class="s">&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;dataSource&quot;</span> <span class="na">ref=</span><span class="s">&quot;dataSource&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;databaseIdProvider&quot;</span> <span class="na">ref=</span><span class="s">&quot;databaseIdProvider&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;mapperLocations&quot;</span> <span class="na">value=</span><span class="s">&quot;classpath*:/config/mapper/**/*.xml&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;/bean&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后在Mapper的xml里，把相应的语句加上<code>databaseId="xxx"</code>就可以了。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
</span><span class='line'><span class="cp">        &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&quot;us.codecraft.webmagic.dao.DynamicClassDao&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nt">&lt;insert</span> <span class="na">id=</span><span class="s">&quot;add&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;us.codecraft.webmagic.model.DynamicClass&quot;</span> <span class="na">databaseId=</span><span class="s">&quot;mysql&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      insert into DynamicClass (`ClassName`,`SourceCode`,`AddTime`,`UpdateTime`)
</span><span class='line'>      values (#{className},#{sourceCode},now(),now())
</span><span class='line'>    <span class="nt">&lt;/insert&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nt">&lt;insert</span> <span class="na">id=</span><span class="s">&quot;add&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;us.codecraft.webmagic.model.DynamicClass&quot;</span> <span class="na">databaseId=</span><span class="s">&quot;h2&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      insert into DynamicClass (`ClassName`,`SourceCode`,`AddTime`,`UpdateTime`)
</span><span class='line'>      values (#{className},#{sourceCode},now(),now())
</span><span class='line'>    <span class="nt">&lt;/insert&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;/mapper&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Spring Profile</h2>

<p>Profile是Spring 3.1后新增的特性，简单来说，就是根据不同的环境，读取不同的配置。这些配置可以放在一起，但是单独生效。贴个代码吧，很容易说明问题了：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
</span><span class='line'><span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
</span><span class='line'>       <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="na">xmlns:jdbc=</span><span class="s">&quot;http://www.springframework.org/schema/jdbc&quot;</span>
</span><span class='line'>       <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/beans</span>
</span><span class='line'><span class="s">      http://www.springframework.org/schema/beans/spring-beans-4.0.xsd http://www.springframework.org/schema/jdbc http://www.springframework.org/schema/jdbc/spring-jdbc.xsd&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;dataSource&quot;</span> <span class="na">class=</span><span class="s">&quot;org.apache.commons.dbcp.BasicDataSource&quot;</span>
</span><span class='line'>          <span class="na">destroy-method=</span><span class="s">&quot;close&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;driverClassName&quot;</span> <span class="na">value=</span><span class="s">&quot;com.mysql.jdbc.Driver&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;url&quot;</span> <span class="na">value=</span><span class="s">&quot;jdbc:mysql://127.0.0.1:3306/WebMagic?characterEncoding=UTF-8&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;username&quot;</span> <span class="na">value=</span><span class="s">&quot;webmagic&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;password&quot;</span> <span class="na">value=</span><span class="s">&quot;webmagic&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/bean&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nt">&lt;beans</span> <span class="na">profile=</span><span class="s">&quot;test&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;dataSource&quot;</span> <span class="na">class=</span><span class="s">&quot;org.apache.commons.dbcp.BasicDataSource&quot;</span>
</span><span class='line'>              <span class="na">destroy-method=</span><span class="s">&quot;close&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;driverClassName&quot;</span> <span class="na">value=</span><span class="s">&quot;org.h2.Driver&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;url&quot;</span> <span class="na">value=</span><span class="s">&quot;jdbc:h2:mem:WebMagic;DB_CLOSE_DELAY=-1&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/bean&gt;</span>
</span><span class='line'>        <span class="c">&lt;!--Refer to https://github.com/springside/springside4/wiki/H2-Database --&gt;</span>
</span><span class='line'>        <span class="nt">&lt;jdbc:initialize-database</span> <span class="na">data-source=</span><span class="s">&quot;dataSource&quot;</span> <span class="na">ignore-failures=</span><span class="s">&quot;ALL&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>            <span class="nt">&lt;jdbc:script</span> <span class="na">location=</span><span class="s">&quot;classpath:sql/h2/schema.sql&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>            <span class="c">&lt;!--&lt;jdbc:script location=&quot;classpath:data/h2/import-data.sql&quot; encoding=&quot;UTF-8&quot;/&gt;--&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/jdbc:initialize-database&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/beans&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nt">&lt;beans</span> <span class="na">profile=</span><span class="s">&quot;standalone&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;dataSource&quot;</span> <span class="na">class=</span><span class="s">&quot;org.apache.commons.dbcp.BasicDataSource&quot;</span>
</span><span class='line'>              <span class="na">destroy-method=</span><span class="s">&quot;close&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;driverClassName&quot;</span> <span class="na">value=</span><span class="s">&quot;org.h2.Driver&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;url&quot;</span> <span class="na">value=</span><span class="s">&quot;jdbc:h2:file:~/.h2/WebMagic;AUTO_SERVER=TRUE&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/bean&gt;</span>
</span><span class='line'>        <span class="c">&lt;!--Refer to https://github.com/springside/springside4/wiki/H2-Database --&gt;</span>
</span><span class='line'>        <span class="nt">&lt;jdbc:initialize-database</span> <span class="na">data-source=</span><span class="s">&quot;dataSource&quot;</span> <span class="na">ignore-failures=</span><span class="s">&quot;ALL&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>            <span class="nt">&lt;jdbc:script</span> <span class="na">location=</span><span class="s">&quot;classpath:sql/h2/schema.sql&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>            <span class="c">&lt;!--&lt;jdbc:script location=&quot;classpath:data/h2/import-data.sql&quot; encoding=&quot;UTF-8&quot;/&gt;--&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/jdbc:initialize-database&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/beans&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;/beans&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>设置Profile有不同的方式。</p>

<p>在JUnit里面，使用注解@ActiveProfile即可。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@RunWith</span><span class="o">(</span><span class="n">SpringJUnit4ClassRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'><span class="nd">@ContextConfiguration</span><span class="o">(</span><span class="n">locations</span> <span class="o">=</span> <span class="o">{</span><span class="s">&quot;classpath*:/config/spring/applicationContext*.xml&quot;</span><span class="o">})</span>
</span><span class='line'><span class="nd">@ActiveProfiles</span><span class="o">(</span><span class="s">&quot;test&quot;</span><span class="o">)</span>
</span><span class='line'><span class="nd">@Transactional</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">AbstractTest</span> <span class="o">{</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Web项目则是在web.xml里设置：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;init-param&gt;</span>
</span><span class='line'>  <span class="nt">&lt;param-name&gt;</span>spring.profiles.active<span class="nt">&lt;/param-name&gt;</span>
</span><span class='line'>  <span class="nt">&lt;param-value&gt;</span>product<span class="nt">&lt;/param-value&gt;</span>
</span><span class='line'><span class="nt">&lt;/init-param&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>如此配置，就可以达到在不同的环境使用不同bean的目的！</p>

<h2>参考资料</h2>

<ul>
<li>H2数据库攻略 <a href="http://www.cnblogs.com/gao241/p/3480472.html">http://www.cnblogs.com/gao241/p/3480472.html</a></li>
<li>spring+mybatis 多数据源整合 <a href="http://blog.csdn.net/fhx007/article/details/12530735">http://blog.csdn.net/fhx007/article/details/12530735</a></li>
<li>如何用Spring 3.1的Environment和Profile简化工作 <a href="http://www.importnew.com/1099.html">http://www.importnew.com/1099.html</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[一次OOM故障排查经过]]></title>
    <link href="http://code4craft.github.com/blog/2014/03/05/yi-ci-oomgu-zhang-pai-cha-jing-guo/"/>
    <updated>2014-03-05T10:00:00+08:00</updated>
    <id>http://code4craft.github.com/blog/2014/03/05/yi-ci-oomgu-zhang-pai-cha-jing-guo</id>
    <content type="html"><![CDATA[<p>本文是一次线上OOM故障排查的经过，内容比较基础但是真实，主要是记录一下，没有OOM排查经验的同学也可以参考。</p>

<!--more-->


<h2>现象</h2>

<p>我们之前有一个计算作业。最近经常出现不稳定，无法正常响应的情况。具体表现是：各种连接超时，从mysql、mongodb和zookeeper到netty，能超时的都超时过了。其他看不到太多有效的异常。</p>

<p>所以我们首先怀疑的是网络问题，打电话跟运维确认，运维说网络问题的可能性几乎为0，因为我们的机器是虚机，宿主机上的其他设备都运转正常。程序问题的可能性更大。继续从应用日志和tomcat的catalina.out中查找日志，发现有一些OutOfMemoryError异常。实际上，出现这个异常就代表内存不够了。</p>

<p>我们使用cat（公司的Java监控平台，已开源<a href="https://github.com/dianping/cat">https://github.com/dianping/cat</a>）查看堆使用的情况，看到如下的东西：</p>

<p><img src="http://static.oschina.net/uploads/space/2014/0305/093930_DljD_190591.png" alt="cat oom" /></p>

<p>Memory Free已经接近了0，同时产生了大量的fullgc。</p>

<p>回到之前的连接timeout，我们知道，Java的连接timeout，除了网络传输的时间，也包括了Java程序处理的时间，所以OOM导致timeout也不奇怪了。</p>

<h2>工具和排查</h2>

<p>之前JVM分析做的很少，在同事的帮助下，结合一点资料，完成了基本的分析。</p>

<p>首先可用的是</p>

<pre><code>jmap -histo PID
</code></pre>

<p>这个命令会将内存中最终保存的对象列出来。</p>

<p><img src="http://static.oschina.net/uploads/space/2014/0305/095032_407L_190591.png" alt="jmap-histo" /></p>

<p>其中&#8221;[&ldquo;表示数组，例如&rdquo;[B&#8221;是byte[]，具体可以看<code>Class.getName()</code>的Javadoc。</p>

<p>但是这个只能粗略定位原因，如果要仔细分析，需要知道是哪些个对象持有了它，这个时候，就需要dump内存下来，再离线分析了。</p>

<p>dump内存的命令是：</p>

<pre><code>jmap -dump:format=b,file=/home/admin/dump.bin PID
</code></pre>

<p>此操作异常耗时，我跟运维在假死的机器上尝试了几次，竟然把tomcat进程干掉了，使用时还是小心为妙…</p>

<p>我这里使用<code>VisualVM</code>进行分析，大致效果如下：</p>

<p><img src="http://static.oschina.net/uploads/space/2014/0305/095802_NpnZ_190591.png" alt="visual-vm" /></p>

<p>这里选择“计算保留大小”。这个保留大小是递归计算实例之间的依赖，得到的总大小。因为去掉了循环依赖，所以并不完全准确，但是用于排查够了。</p>

<p><img src="http://static.oschina.net/uploads/space/2014/0305/231519_981J_190591.png" alt="visual-vm2" /></p>

<p>最后排查出的结果，是公司的RPC中间件使用了ThreadLocal来保存一个context，但是最后却没有释放。按照架构组的说明，升级了版本，问题解决！</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[一点自我分析]]></title>
    <link href="http://code4craft.github.com/blog/2014/02/16/yi-dian-zi-wo-fen-xi/"/>
    <updated>2014-02-16T08:34:00+08:00</updated>
    <id>http://code4craft.github.com/blog/2014/02/16/yi-dian-zi-wo-fen-xi</id>
    <content type="html"><![CDATA[<p>毕业也有两年多了，昨天跟一个老同学打了个电话，他说的混的不行如何如何，我觉得自己倒是混得还好。但是当他说到混得不好依然工资比我多一半时，我陷入了深深的思考…</p>

<!--more-->


<p>从小我就不擅长与人交流。本科四年，大潮流都是享受自由，安心学习的人并不多。不同的是我学业荒废得更多。后来勉强考上研，读研的时候，应该说我是很认真的了，每天大部分时间都在看论文，就这自己的一亩三分地往里钻。可惜导师一直也不怎么管我们，学术方向也是迟迟未定，最后也没做出个名堂。</p>

<p>毕业的时候最失败的事就是没有与人交流。那会同学都去IBM实习了，我自己却不以为然，觉得想去个有挑战的。但是公司的一套技术体系又不熟，准备去阿里和百度的实习，却没有相应的知识准备，连Linux基本操作什么都不会，最后也没成功。后来才知道名企实习经验对找工作的重要性，但是也就晚了。</p>

<p>毕业那会做了个异于常人的选择，我放弃了淘宝的offer，最后去了创新工场，想要参与创业，工资比大家都低一截。后来才理解，应届生创业？在哪都是把你当做劳动力使。</p>

<p>第一份工作我去了点点网，应该说那会还是有点自闭的，因为周围的人工程水平都比我高，那会连Spring都不会。好在虽然工资不高，但是带我的同事还是很好的，水平也过硬，靠着我自己认真学习，在半年之后已经能够独放一面了，做一般的需求都没什么问题。</p>

<p>一年之后我换了工作，来了上海。来之前我经过一年的项目开发，已经属于任何活都能干的了。那会特别自信，觉得自己很厉害了。现在才觉得自己眼界太窄，技术的路很宽，但是由于缺乏与外界的交流，有些东西真的差的还远。</p>

<p>来上海我面试了几个公司，盛大、点评和一号店，其中盛大的面试官是最tough的，问到一些JVM或者AOP的东西，都答得不怎么好，当时没有警觉，因为点评和一号店的都过了，现在才发现其中的问题。</p>

<p>在点评一年，接触了一些真正意义上的专家。我觉得这一年虽然做项目不算多，但是对于我做技术是帮助最大的。一年前我觉得自己还是个技术菜鸟，一年后就得到了很多人的认可。</p>

<p>总结一下，我觉得最大的收获是我找到了自己的一套学习方法。</p>

<p>第一是写博客。我之前也在点点上写博客，多是简单的记录。后来搬到oschina，依然坚持写博客，刚开始只有几个人关注。但是我依然坚持写，有一天，我写的文章突然就上了oschina首页，有了几千的访问量。我们几个朋友之间还奔走相告。这坚定了我继续写博客的信心，同时对质量也有了更多要求。有的时候写一篇博客要花三四天，当然这样也有了更多人的认可。现在经常有人说“看过我的博客”，不得不说还是有点小自豪的。</p>

<p>第二是github。做开发最重要的是写代码写代码，我在业余的时候写了不少项目，比如之前的DNS服务器BlackHole，比如后来的爬虫框架WebMagic。WebMagic因为需求比较广泛，加上我更新比较勤快，以及oschina这个平台，也获得了不少的关注量。</p>

<p>好像说到这里乱掉了？其实我觉得最重要的就是，做事情一定要了解行业一流水平，多交流，不要畏惧，并且找到适合自己的学习方法。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[对自己好一点]]></title>
    <link href="http://code4craft.github.com/blog/2014/02/12/good-to-you/"/>
    <updated>2014-02-12T22:49:00+08:00</updated>
    <id>http://code4craft.github.com/blog/2014/02/12/good-to-you</id>
    <content type="html"><![CDATA[<p>生活是需要刺激的。</p>

<!--more-->


<p>记得在学校的时候，想要跑步，又觉得无聊，就买了个一百多的飞利浦运动耳机，可以入耳的那种。那会一百多块算是个巨款，相当于一周生活费。但是有了它，我坚持了接近5个月的跑步，作为一个胖子，我也交到了第一个女朋友，也就是现在的孩儿他妈。</p>

<p>记得去年突发奇想，花300多块买了个Intellij个人版，结果编程兴趣盎然，一年写了十几个开源项目，其中还有一个得到很多人的关注，小小的出了把名。</p>

<p>现在编程又有点厌倦了，用什么刺激一下呢？</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[代码管理进入大数据时代]]></title>
    <link href="http://code4craft.github.com/blog/2014/01/29/hg-internal/"/>
    <updated>2014-01-29T14:01:00+08:00</updated>
    <id>http://code4craft.github.com/blog/2014/01/29/hg-internal</id>
    <content type="html"><![CDATA[<p>最近Facebook在它们的博客中发布了文章，说到它们扩展了Mercurial（一种代码管理工具），以管理它们日渐庞大的代码。Facebook的代码量有多大？<a href="http://www.informationisbeautiful.net/visualizations/million-lines-of-code/">informationisbeautiful</a>这个网站发布过可视化一个软件代码量的介绍，Facebook的代码量大约是6000万行，超过了Windows Vista和Visual Studio 2012。</p>

<!--more-->


<p>当然这6000万行代码并没有保存在同一个仓库里。根据Facebook的文章，它们主代码仓库，大概有1700万行代码和44000个文件，并且每周有数千的提交。这样大的数据量下，我们常用的版本控制工具，包括git都不好使了，为什么呢？</p>

<p>我们先了解一下版本控制工具的原理。版本控制工具（Version Control System，以下简称VCS，请与CVS分开）从早期的集中式版本控制（CVS，SVN）发展到现在的分布式版本控制（git，Mercurial），使用方式、版本策略变化了很多，但是底层的原理变化并不大。VCS的底层大概可以分为两部分：元数据（版本信息）的管理和变更集（变更文件）的管理。</p>

<p>当我们进行一次提交的时候，首先VCS会产生一个版本号来唯一标记这次提交，在SVN里，这个版本号是一个自增整数，而在git里，它是一个40个字符的SHA1值，而在Mercurial则更复杂一点，它既有自增ID，又有SHA1值。然后VCS会扫描文件，看看哪些文件内容进行了修改，并把这次修改的索引信息保存下来，这就是这次提交的元数据。</p>

<p>而这次被修改的文件，它也会保存下来，在git中，整个项目一次提交的内容都会被压缩并存成一个文件，以该次提交的SHA1值作为文件名，并以树形结构保存下来，又叫tree object。在Mercurial里，它会把该项目的所有提交都打包压缩到changlog文件里，并以版本号来区分，这种格式又叫Revlog。相比之下，git的文件组织更加松耦合一点，所以甚至有人认为git是一种nosql数据库 :D</p>

<p>这里有点意思的是，代码君一直以为VCS对于单个文件的修改是“增量存储”的，而实际上，它是一个全量快照，但是经过了压缩的。后来想想也容易理解，如果是增量存储，那么切换版本的时候，需要把改变一个个摞上去，这个时间是难以接受的！在空间与时间之间，大家都一致选择了浪费空间换取时间！</p>

<p>那么当文件数量大的时候，会出现什么问题呢？</p>

<p>首先，每次提交的速度会变慢，因为每次提交都需要扫描所有文件系统，来判断是否有文件变更。如何解决呢？Facebook之前自己开发过一套监控文件变更的工具WatchMan。它会保存一个目录的文件树，并在操作系统那里注册-每当有文件改变时都会通知它，然后它会维护一个“是否更改”的记录。又是一个典型的“用空间换时间”的做法！然后它们定制了Mercurial，与WatchMan做了适配，于是每次提交的时候，Mercurial就无需扫描文件更改，只需要接收一个“变更文件列表”就行了！</p>

<p>其次，随着版本数增加，因为包含了所有历史文件，整个代码库会变得很巨大。用过git的朋友都知道，clone一个大项目的时间会很漫长，而有的时候，我们只需要最新的一个版本。其实大家都能想到做法是什么了吧？没错，定制过的Mercurial在clone和pull的时候，都只会复制最新版本以及元数据到本地，变更文件是不复制的，而在checkout到指定版本的时候，才会进行复制！有点意思的是，它们觉得这个复制都有点慢，于是使用了Memecached作为文件缓存。</p>

<p>另外，Mercurial大部分代码都是用Python开发，进行定制会比git方便不少，大家是不是有点想试一试呢？Mercurial的意思是“水银“，所以它又叫hg，它的代码地址是<a href="http://selenic.com/repo/hg/">http://selenic.com/repo/hg/</a>。大家这就开始自己的VCS hack之旅吧！</p>

<p>参考资料：</p>

<ul>
<li><a href="https://code.facebook.com/posts/218678814984400/scaling-mercurial-at-facebook/">https://code.facebook.com/posts/218678814984400/scaling-mercurial-at-facebook/</a></li>
<li><a href="https://code.google.com/p/support/wiki/DVCSAnalysis">https://code.google.com/p/support/wiki/DVCSAnalysis</a></li>
<li><a href="http://mercurial.selenic.com/wiki/DeveloperInfo">http://mercurial.selenic.com/wiki/DeveloperInfo</a></li>
<li><a href="http://git-scm.com/book/en/Git-Internals-Git-Objects">http://git-scm.com/book/en/Git-Internals-Git-Objects</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[2013年总结]]></title>
    <link href="http://code4craft.github.com/blog/2013/12/15/2013-review/"/>
    <updated>2013-12-15T23:41:00+08:00</updated>
    <id>http://code4craft.github.com/blog/2013/12/15/2013-review</id>
    <content type="html"><![CDATA[<p>今年是我跟老婆结婚第二年，也是工作第三年，女儿出生、买了房、工作顺利，一切都走上了正轨。</p>

<!--more-->


<h2>生活</h2>

<p>女儿出生是我今年第一大事。老婆一直想要我陪护，但是因为病房不足，所以还是一个人进了产房。7月21号下午4点，老婆被推进产房，当时她脸上满是焦急，和痛苦。期间我忐忑不安，但是老婆非常坚强的完成了顺产。当宝宝被推出来的时候，我的眼泪都忍不住了，只有感觉到浓浓的血缘之情。老婆你真棒！</p>

<p>宝宝出生之后，工作的动力更大了，可能自己也成熟了不少吧。</p>

<p>生活上的事情我做的也不多，还好有父母以及岳母的帮忙。宝宝到现在很健康，多亏了他们，当然，还有老婆。</p>

<p>在父母的资助下，10月份的时候开始了买房之旅，折腾一个月终于敲定，每个月9k的房贷，也是个不小的压力。</p>

<p>今年的生活上，我做的能打个70分，为我老婆打个90分。</p>

<hr />

<h2>工作</h2>

<p>今年工作算是持续进步的一年，也有了一些成果。</p>

<p>今年读的书不多，但是读了好几个项目的源码：jafka、httpclient、jsoup、netty、struts、spring，最重要的是积累了一套自己阅读源码的方式。代码写的更漂亮了，也有一些深层思考了。</p>

<p>写了84篇博客。几个源码解读系列博客，都得到不少朋友的支持，能给人创造价值，感觉是很不错的。其中自我感觉最好的是Netty系列，还没写完，可以继续完善。</p>

<p>5月份开源的webmagic在oschina上收获了不少人气，在完善过程中也认识了不少朋友。现在都有一点知名了呢。这个项目明年会继续完善，并做一些大动作。</p>

<p>为开源项目HttpClient提交patch成功，虽然难度不大，但是毕竟是个好的开始。</p>

<p>工作上得到了领导的肯定，邮件项目和一些日常工作都有了比较好的成绩，应该能得到进一步发展。</p>

<p>长期的目标是能自己出本书，但是自己积累还远远不够，需要继续坚持。</p>

<p>今年的工作和学习能打个90分。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[开始使用hive]]></title>
    <link href="http://code4craft.github.com/blog/2013/11/21/kai-shi-shi-yong-hive/"/>
    <updated>2013-11-21T17:18:00+08:00</updated>
    <id>http://code4craft.github.com/blog/2013/11/21/kai-shi-shi-yong-hive</id>
    <content type="html"><![CDATA[<p>终于到周末了！这周事情不多，仅仅是用hive迁移一个跑脚本的程序，结果写了一周都没弄好，被hive操的生活不能自理了！加上负责的事情逐渐多起来，也变得有点忙了。</p>

<!--more-->


<p>接触一个新领域，总会有控制不住的感觉。开发流程、工具、思路都是新的，还有一些说不清道不明的问题。我也自认为对开发有些心得了，什么东西都能鼓捣鼓捣，但是真正在生产环境，面对对于一个新的领域，仍然会感到手足无措。</p>

<p>我们这边有工作十几年的C++高手，但是换到Java依然会需要向人请教，真可谓隔行如隔山！这大概就是说程序员吃青春饭的原因吧！</p>

<p>其实我挺喜欢挑战，但是对于这么一个跑一遍都要几十分钟的东西来说，实在喜欢不起来。难怪大数据的人才值钱，这东西实在太枯燥了，生命都浪费在执行上了。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Struts2一个[安全问题]的分析报告]]></title>
    <link href="http://code4craft.github.com/blog/2013/11/18/struts2/"/>
    <updated>2013-11-18T09:42:00+08:00</updated>
    <id>http://code4craft.github.com/blog/2013/11/18/struts2</id>
    <content type="html"><![CDATA[<h2>一：起因</h2>

<p>最近公司代码被扫出有一个xss漏洞，检查之后，发现大致是这样一个页面：</p>

<figure class='code'><figcaption><span>DemoAction </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DemoAction</span> <span class="kd">extends</span> <span class="n">ActionSupport</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="nd">@Override</span>
</span><span class='line'>        <span class="kd">public</span> <span class="n">String</span> <span class="nf">execute</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>                <span class="k">return</span> <span class="s">&quot;success&quot;</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">id</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setId</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<!--more-->


<p>模板用的是freemarker，大致是这样子：</p>

<figure class='code'><figcaption><span>demo.ftl </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;html</span> <span class="na">class=</span><span class="s">&quot;G_N&quot;</span><span class="nt">&gt;</span>
</span><span class='line'><span class="nt">&lt;head&gt;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;/head&gt;</span>
</span><span class='line'><span class="nt">&lt;body</span> <span class="na">id=</span><span class="s">&quot;top&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>
</span><span class='line'>${id}
</span><span class='line'><span class="nt">&lt;/body&gt;</span>
</span><span class='line'><span class="nt">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>如果我们访问url<code>/demo?id=&lt;script&gt;alert("xss!")&lt;/script&gt;</code>，会发现id的参数原封不动的打印到了页面上，就会出现反射型xss!</p>

<p>代码在<a href="https://github.com/code4craft/xssdemo">https://github.com/code4craft/xssdemo</a>里的xss-demo tag下。</p>

<h2>二：问题流程</h2>

<p>分析漏洞原因前，先要稍微看一下struts结构(自己画的，可能不严谨)：</p>

<p><img src="http://static.oschina.net/uploads/space/2013/1115/001209_ikf2_190591.jpg" alt="struts2" /></p>

<p>OGNL是底层的表达式引擎，是联系起上下文和模板输出的桥梁。</p>

<p>XWork是个什么东西呢？它可以理解为一个请求-响应模式的通用框架(不仅仅局限于Web)，这个Action就是一个命令。而struts2可以说是XWork在web领域的一个特定实现。</p>

<p>XWork包括Action/Interceptor/Result几个大部分，还有用于执行流程的ActionProxy和ActionInvoker，以及处理数据的ActionContext和ValueStack。</p>

<p>所以参数的转换和注入是在XWork里进行。Struts的主要执行流程在<code>DefaultActionInvocation</code>里。大致解释一下流程：</p>

<p>当Struts捕获到参数时，会交由ognl进行参数转换。我们都知道Struts是通过setter方法进行的参数注入，更进一步的，它是通过ognl表达式来查找方法，并进行属性注入，代码在<code>OgnlRuntime.setProperty</code>里。</p>

<p>那么如果注入不成功呢？<code>OgnlRuntime</code>会抛出<code>MethodFailedException</code>，然后<code>ConversionErrorInterceptor</code>会将<code>原始参数</code>注入到<code>invocation.getStack()</code>中去，而最终freemarker会读取这个原始数据，并打印到页面上(<code>FreemarkerResult</code>)！这个时候，无论字段最终值是什么都不重要了，因为在ognl的Stack里，它已经用原始值给override了！插一句，其实这个值貌似是为了debug用的，会返回名字为&#8221;input&#8221;的result，这样会返回找不到方法的404页面，但是公司使用的貌似不太好用，仍然会正常返回！</p>

<figure class='code'><figcaption><span>ConversionErrorInterceptor </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="k">if</span> <span class="o">(</span><span class="n">fakie</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="c1">// if there were some errors, put the original (fake) values in place right before the result</span>
</span><span class='line'>    <span class="n">stack</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">put</span><span class="o">(</span><span class="n">ORIGINAL_PROPERTY_OVERRIDE</span><span class="o">,</span> <span class="n">fakie</span><span class="o">);</span>
</span><span class='line'>    <span class="n">invocation</span><span class="o">.</span><span class="na">addPreResultListener</span><span class="o">(</span><span class="k">new</span> <span class="n">PreResultListener</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">beforeResult</span><span class="o">(</span><span class="n">ActionInvocation</span> <span class="n">invocation</span><span class="o">,</span> <span class="n">String</span> <span class="n">resultCode</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">Map</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">fakie</span> <span class="o">=</span> <span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;)</span> <span class="n">invocation</span><span class="o">.</span><span class="na">getInvocationContext</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">ORIGINAL_PROPERTY_OVERRIDE</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">fakie</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                 <span class="c1">//注入</span>
</span><span class='line'>                <span class="n">invocation</span><span class="o">.</span><span class="na">getStack</span><span class="o">().</span><span class="na">setExprOverrides</span><span class="o">(</span><span class="n">fakie</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">});</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>三：求解</h2>

<p>那么怎么解决这个问题呢？本着回馈社区的精神，给Struts2官方发了一封邮件，并上传了demo到<a href="https://github.com/code4craft/xssdemo">https://github.com/code4craft/xssdemo</a>。然后过了一天有个叫Lukasz Lenart的大叔程序员回复我了，老外还是很客气的，回答也很及时(算上时差)。首先确认了问题的存在，然后说这不是一个bug，你可以用${id?html}来进行输出转义。我觉得这个解决方案虽然管用，但是是比较反直观的，因为一般人都会直觉上因为这里只是读取Action中的getter取值，既然是基本类型，哪会还需要转义？本来想喷回去的，又搜了一下这个Lukasz Lenart的来历，然后出来这么个：</p>

<p><img src="http://static.oschina.net/uploads/space/2013/1118/212211_F15d_190591.jpg" alt="lukasz" /></p>

<p><img src="http://static.oschina.net/uploads/space/2013/1118/215911_jxug_190591.jpeg" alt="s" /></p>

<p>被lead亮瞎了！亲力亲为，这才是开源项目的氛围嘛！</p>

<p>不过呢，即使大神&amp;作者都发话了，我还是希望有框架内的方案，或许默认对<code>ConversionErrorInterceptor</code>注入时进行HtmlEscape是个不错的主意？于是有了<code>EscapedStrutsConversionErrorInterceptor</code>:</p>

<figure class='code'><figcaption><span>EscapedStrutsConversionErrorInterceptor </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">EscapedStrutsConversionErrorInterceptor</span> <span class="kd">extends</span> <span class="n">StrutsConversionErrorInterceptor</span><span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">protected</span> <span class="n">String</span> <span class="nf">escape</span><span class="o">(</span><span class="n">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">String</span> <span class="n">s</span> <span class="o">=</span> <span class="n">StringEscapeUtils</span><span class="o">.</span><span class="na">escapeHtml4</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">value</span><span class="o">));</span>
</span><span class='line'>        <span class="n">String</span> <span class="n">escape</span> <span class="o">=</span> <span class="kd">super</span><span class="o">.</span><span class="na">escape</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
</span><span class='line'>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;escape &quot;</span><span class="o">+</span><span class="n">value</span><span class="o">+</span><span class="s">&quot; to &quot;</span><span class="o">+</span> <span class="n">s</span><span class="o">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">escape</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后在项目里将默认的<code>converionError</code>替换为我们的新类就可以了！怎么定义stack?看看struts-core包里的struts-default.xml就知道了！(PS:自定义interceptor是Struts里很有用的技巧，大家不妨自己研究一下)。修改过的代码：<a href="https://github.com/code4craft/xssdemo/blob/master/src/main/resources/config/struts/struts.xml">https://github.com/code4craft/xssdemo/blob/master/src/main/resources/config/struts/struts.xml</a></p>

<p>当然还有一种办法，就是直接在request参数中过滤。但是这里就要区分哪些需要过滤，哪些不要过滤。我们公司使用了一套在字段上加注解的方法，解决了这个问题，也是可行的，不过就需要修改代码了。</p>

<p>参考资料：</p>

<ol>
<li>《Struts2技术内幕》<a href="http://book.douban.com/subject/7154446/">http://book.douban.com/subject/7154446/</a></li>
</ol>

]]></content>
  </entry>
  
</feed>
